<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="css/style.css">
    <style type="text/css">
        /* Style for the order summary table */
        #order-summary {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        /* Style for table headers */
        #order-summary th {
            background-color: #f2f2f2;
            padding: 10px;
            text-align: left;
        }

        /* Style for table rows */
        #order-summary td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        /* Style for total row */
        #order-summary tfoot td {
            font-weight: bold;
        }

        /* Style for total amount */
        #total-amount {
            font-size: 1.2rem;
            color: #007bff;
        }

        /* Style for the shipping information form */
        #shipping-form {
            width: 100%;
            max-width: 600px;
        }

        /* Style for form groups */
        .form-group {
            margin-bottom: 20px;
        }

        /* Style for form labels */
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        /* Style for form input fields */
        .form-group input {
            width: calc(100% - 20px);
            /* Adjust for padding */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Style for submit button */
        #shipping-form button[type="submit"] {
            background-color: #007bff;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #shipping-form button[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>E-Cooking Appliances</h1>
            <nav>
                <div class="toggle-menu">&#9776;</div>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#">Products</a></li>
                    <li id="login-link" style="display: none;"><a href="login.html">Login or Register</a></li>
                    <li id="logout-link" style="display: none;"><a href="#" id="logout">Logout</a></li>
                    <li>
                        <a href="cart.html" class="cart-link">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                                fill="#fff"> <!-- Change fill color to white -->
                                <path d="M0 0h24v24H0z" fill="none" />
                                <path
                                    d="M9 19c0 1.1.9 2 2 2s2-.9 2-2h6c0 1.1.9 2 2 2s2-.9 2-2h1c1.1 0 1.99-.9 1.99-2L23 5c0-.55-.45-1-1-1H6L5.26 2.05C5.1 1.55 4.63 1.26 4.1 1.26L3.21 1l-.43-.43C2.54.54 2 1.01 2 1.57L2 3H1c-.55 0-1 .45-1 1s.45 1 1 1h1v14c0 1.1.9 2 2 2h6zM7.5 19c-.83 0-1.5-.67-1.5-1.5S6.67 16 7.5 16s1.5.67 1.5 1.5S8.33 19 7.5 19zm11 0c-.83 0-1.5-.67-1.5-1.5S17.67 16 18.5 16s1.5.67 1.5 1.5S19.33 19 18.5 19zm2-14H4l1.5 1.5h13L20.5 5zM7 7h10v2H7V7z" />
                            </svg>
                            <span class="cart-badge">
                                <span class="badge-counter">0</span>
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        <div class="container">
            <h2>Order Summary</h2>
            <table id="order-summary">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Cart items will be dynamically added here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Total</td>
                        <td id="total-amount">$0.00</td>
                    </tr>
                </tfoot>
            </table>

            <h2>Shipping Information</h2>
            <form id="shipping-form">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" required>
                </div>
                <!-- Add more fields as needed for shipping information -->
                <button type="submit">Continue to Payment</button>
            </form>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Simple E-commerce. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get cart items from local storage
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];

            // Select the table body to append cart items
            const tbody = document.querySelector('#order-summary tbody');

            // Clear previous content
            tbody.innerHTML = '';

            // Initialize total amount
            let total = 0;

            // Loop through cart items
            cartItems.forEach(cartItem => {
                // Fetch product details based on product ID
                fetch(`http://localhost:3000/api/products/${cartItem.productId}`)
                    .then(response => response.json())
                    .then(product => {
                        // Calculate total price for the item
                        const totalPrice = cartItem.quantity * product.price;

                        // Update total amount
                        total += totalPrice;

                        // Create table row for the cart item
                        const row = document.createElement('tr');
                        row.innerHTML = `
                <td>${product.name}</td>
                <td>$${product.price.toFixed(2)}</td>
                <td>${cartItem.quantity}</td>
                <td>$${totalPrice.toFixed(2)}</td>
            `;

                        // Append row to table body
                        tbody.appendChild(row);

                        // Update total amount in the footer
                        document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
                    })
                    .catch(error => {
                        console.error('Error fetching product details:', error);
                    });
            });

            const shippingForm = document.getElementById('shipping-form');

            shippingForm.addEventListener('submit', function (event) {
                // Prevent default form submission behavior
                event.preventDefault();

                // Serialize form data into JSON format
                const formData = new FormData(shippingForm);
                const serializedData = {};
                for (const [key, value] of formData.entries()) {
                    serializedData[key] = value;
                }

                // Make an AJAX POST request to the backend API
                fetch('http://localhost:3000/api/transactions/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serializedData)
                })
                    .then(response => {
                        if (response.ok) {
                            // Redirect to the payment page upon successful checkout
                            window.location.href = 'payment.html';
                        } else {
                            // Handle errors
                            console.error('Error during checkout:', response.statusText);
                            alert('Error during checkout. Please try again later.');
                        }
                    })
                    .catch(error => {
                        console.error('Error during checkout:', error);
                        alert('Error during checkout. Please try again later.');
                    });
            });
        });

    </script>

</html>